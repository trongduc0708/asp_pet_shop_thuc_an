@model Pet_Shop.Models.Entities.Order
@{
    ViewData["Title"] = "Chi tiết đơn hàng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-receipt me-2"></i>Chi tiết đơn hàng #@Model.OrderNumber
            </h2>
            <div>
                <a href="@Url.Action("Orders")" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </a>
                <button type="button" class="btn btn-primary" onclick="showUpdateStatusModal(@Model.OrderID, @Model.StatusID, '@Model.Status.StatusName')">
                    <i class="fas fa-edit me-2"></i>Cập nhật trạng thái
                </button>
            </div>
        </div>

        <div class="row">
            <!-- Order Information -->
            <div class="col-md-8">
                <!-- Order Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Trạng thái đơn hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                @{
                                    var statusClass = Model.Status.StatusName switch
                                    {
                                        "Mới" => "bg-primary",
                                        "Đang xử lý" => "bg-warning",
                                        "Đang giao" => "bg-info",
                                        "Đã giao" => "bg-success",
                                        "Đã hủy" => "bg-danger",
                                        _ => "bg-secondary"
                                    };
                                }
                                <span class="badge @statusClass fs-6">@Model.Status.StatusName</span>
                            </div>
                            <div class="col-md-6 text-end">
                                <small class="text-muted">Cập nhật: @Model.UpdatedDate.ToString("dd/MM/yyyy HH:mm")</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Thông tin khách hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td class="fw-bold">Họ tên:</td>
                                        <td>@Model.User.FullName</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Email:</td>
                                        <td>@Model.User.Email</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td class="fw-bold">Ngày đặt:</td>
                                        <td>@Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Phương thức thanh toán:</td>
                                        <td><span class="badge bg-secondary">@Model.PaymentMethod.MethodName</span></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Sản phẩm trong đơn hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Đơn giá</th>
                                        <th>Số lượng</th>
                                        <th>Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.OrderItems)
                                    {
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    @if (item.Product.ProductImages != null && item.Product.ProductImages.Any())
                                                    {
                                                        <img src="@item.Product.ProductImages.First().ImageURL" 
                                                             alt="@item.Product.ProductName" 
                                                             class="img-thumbnail me-3" 
                                                             style="width: 60px; height: 60px; object-fit: cover;">
                                                    }
                                                    else
                                                    {
                                                        <div class="bg-light d-flex align-items-center justify-content-center me-3" 
                                                             style="width: 60px; height: 60px;">
                                                            <i class="fas fa-image text-muted"></i>
                                                        </div>
                                                    }
                                                    <div>
                                                        <strong>@item.Product.ProductName</strong>
                                                        <br>
                                                        <small class="text-muted">@item.Product.ProductCode</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>@item.UnitPrice.ToString("N0") ₫</td>
                                            <td>
                                                <span class="badge bg-primary">@item.Quantity</span>
                                            </td>
                                            <td>
                                                <strong class="text-success">@item.TotalPrice.ToString("N0") ₫</strong>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Địa chỉ giao hàng</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">@Model.ShippingAddress</p>
                    </div>
                </div>

                <!-- Notes -->
                @if (!string.IsNullOrEmpty(Model.Notes) || !string.IsNullOrEmpty(Model.AdminNotes))
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Ghi chú</h5>
                        </div>
                        <div class="card-body">
                            @if (!string.IsNullOrEmpty(Model.Notes))
                            {
                                <div class="mb-3">
                                    <h6>Ghi chú của khách hàng:</h6>
                                    <p class="text-muted">@Model.Notes</p>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Model.AdminNotes))
                            {
                                <div>
                                    <h6>Ghi chú của admin:</h6>
                                    <p class="text-muted">@Model.AdminNotes</p>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Order Summary -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Tóm tắt đơn hàng</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <td>Tạm tính:</td>
                                <td class="text-end">@Model.SubTotal.ToString("N0") ₫</td>
                            </tr>
                            <tr>
                                <td>Phí vận chuyển:</td>
                                <td class="text-end">@Model.ShippingFee.ToString("N0") ₫</td>
                            </tr>
                            @if (Model.DiscountAmount > 0)
                            {
                                <tr>
                                    <td>Giảm giá:</td>
                                    <td class="text-end text-danger">-@Model.DiscountAmount.ToString("N0") ₫</td>
                                </tr>
                            }
                            <tr class="border-top">
                                <td class="fw-bold">Tổng cộng:</td>
                                <td class="text-end fw-bold text-success fs-5">@Model.TotalAmount.ToString("N0") ₫</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Order History -->
                @if (Model.OrderStatusHistories != null && Model.OrderStatusHistories.Any())
                {
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">Lịch sử trạng thái</h5>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                @foreach (var history in Model.OrderStatusHistories.OrderByDescending(h => h.ChangedDate))
                                {
                                    <div class="timeline-item">
                                        <div class="timeline-marker"></div>
                                        <div class="timeline-content">
                                            <h6 class="mb-1">
                                                @if (history.OldStatus != null)
                                                {
                                                    <span>@history.OldStatus.StatusName</span>
                                                    <i class="fas fa-arrow-right mx-2"></i>
                                                }
                                                <span class="text-primary">@history.NewStatus.StatusName</span>
                                            </h6>
                                            <small class="text-muted">@history.ChangedDate.ToString("dd/MM/yyyy HH:mm")</small>
                                            @if (!string.IsNullOrEmpty(history.Notes))
                                            {
                                                <p class="mb-0 mt-1">@history.Notes</p>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateStatusModalLabel">Cập nhật trạng thái đơn hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <input type="hidden" id="orderId" name="orderId">
                    
                    <div class="mb-3">
                        <label class="form-label">Trạng thái hiện tại</label>
                        <input type="text" id="currentStatus" class="form-control" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newStatusId" class="form-label">Trạng thái mới <span class="text-danger">*</span></label>
                        <select id="newStatusId" name="newStatusId" class="form-select" required>
                            <option value="">-- Chọn trạng thái mới --</option>
                            @if (ViewBag.OrderStatuses != null)
                            {
                                @foreach (var status in ViewBag.OrderStatuses)
                                {
                                    <option value="@status.StatusID">@status.StatusName</option>
                                }
                            }
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusNotes" class="form-label">Ghi chú</label>
                        <textarea id="statusNotes" name="notes" class="form-control" rows="3" placeholder="Nhập ghi chú về việc thay đổi trạng thái..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="updateOrderStatus()">
                    <i class="fas fa-save me-2"></i>Cập nhật
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update Admin Notes Modal -->
<div class="modal fade" id="updateNotesModal" tabindex="-1" aria-labelledby="updateNotesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateNotesModalLabel">Cập nhật ghi chú admin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateNotesForm">
                    <input type="hidden" id="notesOrderId" name="orderId">
                    
                    <div class="mb-3">
                        <label for="adminNotes" class="form-label">Ghi chú admin</label>
                        <textarea id="adminNotes" name="adminNotes" class="form-control" rows="4" placeholder="Nhập ghi chú của admin...">@Model.AdminNotes</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="updateOrderNotes()">
                    <i class="fas fa-save me-2"></i>Cập nhật
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -25px;
    top: 5px;
    width: 10px;
    height: 10px;
    background-color: #007bff;
    border-radius: 50%;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -21px;
    top: 15px;
    width: 2px;
    height: 100%;
    background-color: #dee2e6;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #007bff;
}
</style>

<script>
function showUpdateStatusModal(orderId, currentStatusId, currentStatusName) {
    document.getElementById('orderId').value = orderId;
    document.getElementById('currentStatus').value = currentStatusName;
    document.getElementById('newStatusId').value = '';
    document.getElementById('statusNotes').value = '';
    
    // Disable current status option
    const statusSelect = document.getElementById('newStatusId');
    Array.from(statusSelect.options).forEach(option => {
        option.disabled = option.value == currentStatusId;
    });
    
    new bootstrap.Modal(document.getElementById('updateStatusModal')).show();
}

function updateOrderStatus() {
    const orderId = document.getElementById('orderId').value;
    const newStatusId = document.getElementById('newStatusId').value;
    const notes = document.getElementById('statusNotes').value;
    
    if (!newStatusId) {
        showWarningModal('Vui lòng chọn trạng thái mới', 'Bạn cần chọn trạng thái mới trước khi cập nhật.');
        return;
    }
    
    const formData = new FormData();
    formData.append('newStatusId', newStatusId);
    formData.append('notes', notes);
    
    fetch(`/Admin/Orders/${orderId}/UpdateStatus`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessModal(data.message, 'Trạng thái đơn hàng đã được cập nhật thành công.');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorModal('Lỗi: ' + data.message, 'Không thể cập nhật trạng thái đơn hàng.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorModal('Có lỗi xảy ra khi cập nhật trạng thái', 'Vui lòng thử lại sau.');
    });
}

function showUpdateNotesModal() {
    document.getElementById('notesOrderId').value = @Model.OrderID;
    new bootstrap.Modal(document.getElementById('updateNotesModal')).show();
}

function updateOrderNotes() {
    const orderId = document.getElementById('notesOrderId').value;
    const adminNotes = document.getElementById('adminNotes').value;
    
    const formData = new FormData();
    formData.append('adminNotes', adminNotes);
    
    fetch(`/Admin/Orders/${orderId}/UpdateNotes`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessModal(data.message, 'Ghi chú đã được cập nhật thành công.');
            setTimeout(() => location.reload(), 1500);
        } else {
            showErrorModal('Lỗi: ' + data.message, 'Không thể cập nhật ghi chú.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorModal('Có lỗi xảy ra khi cập nhật ghi chú', 'Vui lòng thử lại sau.');
    });
}
</script>
