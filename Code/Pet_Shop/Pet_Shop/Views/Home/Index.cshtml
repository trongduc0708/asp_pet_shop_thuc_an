@{
    ViewData["Title"] = "Home";
}

<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        @if (ViewBag.Banners != null && ((IEnumerable<Pet_Shop.Models.Entities.Banner>)ViewBag.Banners).Any())
        {
            <!-- Banner Carousel -->
            <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    @{
                        var banners = (IEnumerable<Pet_Shop.Models.Entities.Banner>)ViewBag.Banners;
                        var bannerList = banners.ToList();
                    }
                    @for (int i = 0; i < bannerList.Count; i++)
                    {
                        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="@i" 
                                class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" 
                                aria-label="Slide @(i + 1)"></button>
                    }
                </div>
                <div class="carousel-inner">
                    @for (int i = 0; i < bannerList.Count; i++)
                    {
                        var banner = bannerList[i];
                        <div class="carousel-item @(i == 0 ? "active" : "")">
                            <div class="hero-content">
                                <div class="row align-items-center">
                                    <div class="col-lg-6">
                                        <div class="hero-text fade-in-up">
                                            <div class="discount-badge">SAVE 10 - 20 % OFF</div>
                                            <h1>
                                                @Html.Raw(banner.BannerName.Replace("\n", "<br>"))
                                            </h1>
                                            <p class="lead">
                                                Chuyên cung cấp thức ăn và phụ kiện chất lượng cao cho thú cưng của bạn. 
                                                Với hơn 10,000 sản phẩm từ các thương hiệu uy tín.
                                            </p>
                                            @if (!string.IsNullOrEmpty(banner.LinkURL))
                                            {
                                                <a href="@banner.LinkURL" class="shop-btn">
                                                    SHOP NOW <i class="fas fa-arrow-right ms-2"></i>
                                                </a>
                                            }
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="hero-image fade-in-up">
                                            <img src="@banner.ImageURL" alt="@banner.BannerName" class="img-fluid">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        }
        else
        {
            <!-- Fallback Hero Section -->
            <div class="hero-content">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <div class="hero-text fade-in-up">
                            <div class="discount-badge">SAVE 10 - 20 % OFF</div>
                            <h1>
                                Best Destination<br>
                                For <span class="highlight">Your Pets</span>
                            </h1>
                            <p class="lead">
                                Chuyên cung cấp thức ăn và phụ kiện chất lượng cao cho thú cưng của bạn. 
                                Với hơn 10,000 sản phẩm từ các thương hiệu uy tín.
                            </p>
                            <a href="#" class="shop-btn">
                                SHOP NOW <i class="fas fa-arrow-right ms-2"></i>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="hero-image fade-in-up">
                            <img src="https://images.unsplash.com/photo-1552053831-71594a27632d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80" 
                                 alt="Happy Dog with Toy" class="img-fluid">
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</section>

<!-- AI Chatbot Recommendations (Only for logged in users with purchase history) -->
@if (ViewBag.AIRecommendedProducts != null && ((IEnumerable<Pet_Shop.Models.Entities.Product>)ViewBag.AIRecommendedProducts).Any())
{
    <section class="py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center mb-5">
                    <div class="ai-badge mb-3">
                        <span class="badge bg-warning text-dark px-4 py-2 fs-6 pulse-animation">
                            <i class="fas fa-robot me-2"></i>AI CHATBOT GỢI Ý
                        </span>
                    </div>
                    <h2 class="display-5 fw-bold text-white">Sản Phẩm Dành Riêng Cho Bạn</h2>
                    <p class="lead text-white-50">
                        <i class="fas fa-brain me-2"></i>
                        Được phân tích bởi AI chatbot dựa trên lịch sử mua hàng của bạn
                    </p>
                </div>
            </div>
            <div class="row">
                @foreach (var product in ViewBag.AIRecommendedProducts)
                {
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card product-card h-100 shadow-lg border-0 ai-product-card">
                            <div class="position-relative">
                                @if (product.ProductImages != null && product.ProductImages.Count > 0)
                                {
                                    @foreach (var image in product.ProductImages)
                                    {
                                        <img src="@image.ImageURL" class="card-img-top" alt="@image.AltText" style="height: 200px; object-fit: cover;">
                                        break;
                                    }
                                }
                                else
                                {
                                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                    </div>
                                }
                                <div class="position-absolute top-0 start-0 m-2">
                                    <span class="badge bg-success">
                                        <i class="fas fa-robot me-1"></i>AI Gợi ý
                                    </span>
                                </div>
                                @{
                                    var salePrice = product.SalePrice != null ? (decimal?)product.SalePrice : null;
                                    var hasSalePrice = salePrice.HasValue && salePrice.Value > 0 && salePrice.Value < product.Price;
                                }
                                @if (hasSalePrice)
                                {
                                    var discount = ((product.Price - salePrice.Value) / product.Price) * 100;
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-danger">
                                            -@discount.ToString("0")%
                                        </span>
                                    </div>
                                }
                            </div>
                            
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title text-dark">@product.ProductName</h5>
                                <p class="card-text text-muted small">@product.ShortDescription</p>
                                
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        @{
                                            var currentSalePrice = product.SalePrice != null ? (decimal?)product.SalePrice : null;
                                            var hasDiscount = currentSalePrice.HasValue && currentSalePrice.Value > 0 && currentSalePrice.Value < product.Price;
                                        }
                                        @if (hasDiscount)
                                        {
                                            <div>
                                                <span class="text-danger fw-bold fs-5">@currentSalePrice.Value.ToString("N0") ₫</span>
                                                <small class="text-muted text-decoration-line-through d-block">@product.Price.ToString("N0") ₫</small>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="fw-bold text-primary fs-5">@product.Price.ToString("N0") ₫</span>
                                        }
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <a href="/Shop/Product/@product.ProductID" class="btn btn-outline-light btn-sm flex-fill">
                                            <i class="fas fa-eye me-1"></i>Xem
                                        </a>
                                        <button type="button" class="btn btn-warning btn-sm add-to-cart-btn" data-product-id="@product.ProductID">
                                            <i class="fas fa-shopping-cart"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-light btn-sm wishlist-btn" data-product-id="@product.ProductID" title="Thêm vào yêu thích">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="row mt-3">
                <div class="col-12 text-center">
                    <p class="text-white-50 small">
                        <i class="fas fa-info-circle me-2"></i>
                        Các sản phẩm được gợi ý bởi AI Chatbot dựa trên phân tích lịch sử mua hàng và sở thích của bạn
                    </p>
                </div>
            </div>
        </div>
    </section>
}

<!-- Featured Products Section -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center mb-5">
                <h2 class="display-5 fw-bold text-dark">Sản phẩm nổi bật</h2>
                <p class="lead text-muted">Những sản phẩm được yêu thích nhất</p>
            </div>
        </div>
        <div class="row">
            @if (ViewBag.FeaturedProducts != null && ((IEnumerable<Pet_Shop.Models.Entities.Product>)ViewBag.FeaturedProducts).Any())
            {
                @foreach (var product in ViewBag.FeaturedProducts)
                {
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card product-card h-100">
                            @if (product.ProductImages != null && product.ProductImages.Count > 0)
                            {
                                @foreach (var image in product.ProductImages)
                                {
                                    <img src="@image.ImageURL" class="card-img-top" alt="@image.AltText" style="height: 200px; object-fit: cover;">
                                    break;
                                }
                            }
                            else
                            {
                                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                    <i class="fas fa-image fa-3x text-muted"></i>
                                </div>
                            }
                            
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">@product.ProductName</h5>
                                <p class="card-text">@product.ShortDescription</p>
                                
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        @if (product.SalePrice != null && product.SalePrice < product.Price)
                                        {
                                            <div>
                                                <span class="text-danger fw-bold">@product.SalePrice.ToString("N0") ₫</span>
                                                <small class="text-muted text-decoration-line-through">@product.Price.ToString("N0") ₫</small>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="fw-bold">@product.Price.ToString("N0") ₫</span>
                                        }
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <a href="/Shop/Product/@product.ProductID" class="btn btn-outline-primary btn-sm flex-fill">Xem chi tiết</a>
                                        <button type="button" class="btn btn-primary btn-sm add-to-cart-btn" data-product-id="@product.ProductID">
                                            <i class="fas fa-shopping-cart"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm wishlist-btn" data-product-id="@product.ProductID" title="Thêm vào yêu thích">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- Fallback products if database is not available -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card product-card">
                        <img src="https://images.unsplash.com/photo-1583337130417-3346a1be7dee?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80" 
                             class="card-img-top" alt="Dog Food">
                        <div class="card-body">
                            <h5 class="card-title">Thức ăn chó Royal Canin</h5>
                            <p class="card-text">Thức ăn cao cấp cho chó trưởng thành</p>
                            <div class="price">299,000 VNĐ</div>
                            <button class="btn btn-primary">Thêm vào giỏ</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card product-card">
                        <img src="https://images.unsplash.com/photo-1551717743-49959800b1f6?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80" 
                             class="card-img-top" alt="Cat Food">
                        <div class="card-body">
                            <h5 class="card-title">Thức ăn mèo Whiskas</h5>
                            <p class="card-text">Thức ăn ướt cho mèo</p>
                            <div class="price">45,000 VNĐ</div>
                            <button class="btn btn-primary">Thêm vào giỏ</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card product-card">
                        <img src="https://images.unsplash.com/photo-1583337130417-3346a1be7dee?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80" 
                             class="card-img-top" alt="Dog Toy">
                        <div class="card-body">
                            <h5 class="card-title">Đồ chơi cho chó</h5>
                            <p class="card-text">Bóng cao su bền bỉ</p>
                            <div class="price">89,000 VNĐ</div>
                            <button class="btn btn-primary">Thêm vào giỏ</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card product-card">
                        <img src="https://images.unsplash.com/photo-1551717743-49959800b1f6?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80" 
                             class="card-img-top" alt="Cat Accessory">
                        <div class="card-body">
                            <h5 class="card-title">Khay cát cho mèo</h5>
                            <p class="card-text">Khay cát cao cấp có nắp</p>
                            <div class="price">199,000 VNĐ</div>
                            <button class="btn btn-primary">Thêm vào giỏ</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</section>

<!-- Categories Section -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center mb-5">
                <h2 class="display-5 fw-bold text-dark">Danh mục sản phẩm</h2>
                <p class="lead text-muted">Tìm kiếm theo loại thú cưng</p>
            </div>
        </div>
        <div class="row">
            @if (ViewBag.Categories != null)
            {
                @foreach (var category in ViewBag.Categories)
                {
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-center border-0 shadow-sm">
                            <div class="card-body p-4">
                                @{
                                    var iconClass = category.CategoryName.ToLower() switch
                                    {
                                        var name when name.Contains("chó") => "fas fa-dog",
                                        var name when name.Contains("mèo") => "fas fa-cat",
                                        var name when name.Contains("phụ kiện") => "fas fa-bone",
                                        _ => "fas fa-paw"
                                    };
                                }
                                <i class="@iconClass fa-3x text-warning mb-3"></i>
                                <h5 class="card-title">@category.CategoryName</h5>
                                <p class="card-text">@(category.Description ?? "Sản phẩm chất lượng cao")</p>
                                <a href="@Url.Action("Products", "Shop", new { categoryId = category.CategoryID })" class="btn btn-outline-warning">Xem sản phẩm</a>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- Fallback categories if database is not available -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card text-center border-0 shadow-sm">
                        <div class="card-body p-4">
                            <i class="fas fa-dog fa-3x text-warning mb-3"></i>
                            <h5 class="card-title">Thức ăn chó</h5>
                            <p class="card-text">Thức ăn khô và ướt cho chó</p>
                            <a href="#" class="btn btn-outline-warning">Xem sản phẩm</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card text-center border-0 shadow-sm">
                        <div class="card-body p-4">
                            <i class="fas fa-cat fa-3x text-warning mb-3"></i>
                            <h5 class="card-title">Thức ăn mèo</h5>
                            <p class="card-text">Thức ăn khô và ướt cho mèo</p>
                            <a href="#" class="btn btn-outline-warning">Xem sản phẩm</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card text-center border-0 shadow-sm">
                        <div class="card-body p-4">
                            <i class="fas fa-bone fa-3x text-warning mb-3"></i>
                            <h5 class="card-title">Phụ kiện chó</h5>
                            <p class="card-text">Dây dắt, đồ chơi, chuồng</p>
                            <a href="#" class="btn btn-outline-warning">Xem sản phẩm</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card text-center border-0 shadow-sm">
                        <div class="card-body p-4">
                            <i class="fas fa-paw fa-3x text-warning mb-3"></i>
                            <h5 class="card-title">Phụ kiện mèo</h5>
                            <p class="card-text">Khay cát, vòng cổ, đồ chơi</p>
                            <a href="#" class="btn btn-outline-warning">Xem sản phẩm</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</section>

<!-- Promotion Popup -->
<div id="promotionPopup" class="promotion-popup-overlay">
    <div class="promotion-popup">
        <div class="promotion-popup-header">
            <button class="promotion-popup-close" onclick="closePromotionPopup()">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="promotion-popup-title">
                <i class="fas fa-gift me-2"></i>
                Mã Khuyến Mãi Đặc Biệt
            </h3>
            <p class="promotion-popup-subtitle">Những ưu đãi hấp dẫn đang chờ bạn!</p>
        </div>
        <div class="promotion-popup-body" id="promotionPopupBody">
            <!-- Promotion cards will be loaded here -->
        </div>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function() {
    // Check for active promotions and show popup
    checkAndShowPromotionPopup();
    
    $('.add-to-cart-btn').on('click', function() {
        var productId = $(this).data('product-id');
        var $btn = $(this);
        var originalHtml = $btn.html();
        
        // Disable button and show loading
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '/Cart/AddToCart',
            type: 'POST',
            data: {
                productId: productId,
                quantity: 1
            },
            success: function(response) {
                if (response.success) {
                    // Show success message
                    showToast('success', response.message);
                    
                    // Update cart count in header if exists
                    if (response.cartCount !== undefined) {
                        $('#cartCount').text(response.cartCount);
                        if (response.cartCount > 0) {
                            $('#cartCount').show();
                        } else {
                            $('#cartCount').hide();
                        }
                    }
                } else {
                    showToast('error', response.message);
                }
            },
            error: function(xhr, status, error) {
                showToast('error', 'Có lỗi xảy ra khi thêm vào giỏ hàng');
            },
            complete: function() {
                // Re-enable button
                $btn.prop('disabled', false).html(originalHtml);
            }
        });
    });
    
    // Wishlist functionality
    $('.wishlist-btn').on('click', function() {
        var productId = $(this).data('product-id');
        var $btn = $(this);
        var originalHtml = $btn.html();
        
        // Disable button and show loading
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '/Wishlist/AddToWishlist',
            type: 'POST',
            data: {
                productId: productId
            },
            success: function(response) {
                if (response.success) {
                    // Change button to filled heart
                    $btn.removeClass('btn-outline-danger').addClass('btn-danger');
                    $btn.html('<i class="fas fa-heart"></i>');
                    $btn.attr('title', 'Đã thêm vào yêu thích');
                    
                    showToast('success', response.message);
                } else {
                    showToast('error', response.message);
                }
            },
            error: function(xhr, status, error) {
                showToast('error', 'Có lỗi xảy ra khi thêm vào yêu thích');
            },
            complete: function() {
                // Re-enable button
                $btn.prop('disabled', false);
            }
        });
    });
    
    function showToast(type, message) {
        // Create toast element
        var toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // Add to toast container
        if ($('#toastContainer').length === 0) {
            $('body').append('<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>');
        }
        
        $('#toastContainer').append(toastHtml);
        
        // Show toast
        var toastElement = $('#toastContainer .toast').last();
        var toast = new bootstrap.Toast(toastElement[0]);
        toast.show();
        
        // Remove toast element after it's hidden
        toastElement.on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }
});

// Function to check and show promotion popup
function checkAndShowPromotionPopup() {
    // Check if popup was already shown in this session
    if (sessionStorage.getItem('promotionPopupShown') === 'true') {
        return;
    }
    
    // Load active promotions
    $.ajax({
        url: '/Home/GetActivePromotions',
        type: 'GET',
        success: function(response) {
            if (response.success && response.data && response.data.length > 0) {
                loadPromotionPopup(response.data);
                showPromotionPopup();
                // Mark as shown in this session
                sessionStorage.setItem('promotionPopupShown', 'true');
            }
        },
        error: function() {
            console.log('Error loading promotions');
        }
    });
}

// Function to load promotion data into popup
function loadPromotionPopup(promotions) {
    var popupBody = $('#promotionPopupBody');
    popupBody.empty();
    
    if (promotions.length === 0) {
        popupBody.html(`
            <div class="promotion-empty">
                <i class="fas fa-gift"></i>
                <h4>Không có mã khuyến mãi</h4>
                <p>Hiện tại chưa có mã khuyến mãi nào đang hoạt động</p>
            </div>
        `);
        return;
    }
    
    promotions.forEach(function(promotion) {
        var discountText = '';
        if (promotion.discountType === 'Percentage') {
            discountText = `Giảm ${promotion.discountValue}%`;
        } else {
            discountText = `Giảm ${promotion.discountValue.toLocaleString('vi-VN')} ₫`;
        }
        
        var minOrderText = promotion.minOrderAmount > 0 ? 
            `Đơn tối thiểu ${promotion.minOrderAmount.toLocaleString('vi-VN')} ₫` : 
            'Không giới hạn';
        
        var usageText = promotion.usageLimit ? 
            `Còn ${promotion.usageLimit - promotion.usedCount} lượt` : 
            'Không giới hạn lượt';
        
        var cardHtml = `
            <div class="promotion-card">
                <div class="promotion-code">${promotion.promotionCode}</div>
                <div class="promotion-name">${promotion.promotionName}</div>
                <div class="promotion-description">${promotion.description || 'Mã khuyến mãi đặc biệt'}</div>
                <div class="promotion-details">
                    <div class="promotion-discount">${discountText}</div>
                    <div class="promotion-min-order">${minOrderText}</div>
                    <button class="promotion-copy-btn" onclick="copyPromotionCode('${promotion.promotionCode}', this)">
                        <i class="fas fa-copy"></i>
                        Sao chép mã
                    </button>
                </div>
                <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 8px;">
                    <i class="fas fa-clock"></i> ${usageText}
                </div>
            </div>
        `;
        
        popupBody.append(cardHtml);
    });
}

// Function to show promotion popup
function showPromotionPopup() {
    $('#promotionPopup').addClass('show');
    $('body').css('overflow', 'hidden'); // Prevent background scrolling
}

// Function to close promotion popup
function closePromotionPopup() {
    $('#promotionPopup').removeClass('show');
    $('body').css('overflow', ''); // Restore scrolling
}

// Function to copy promotion code
function copyPromotionCode(code, button) {
    navigator.clipboard.writeText(code).then(function() {
        var $btn = $(button);
        var originalText = $btn.html();
        
        $btn.addClass('copied').html('<i class="fas fa-check"></i> Đã sao chép');
        
        setTimeout(function() {
            $btn.removeClass('copied').html(originalText);
        }, 2000);
        
        showToast('success', 'Đã sao chép mã khuyến mãi: ' + code);
    }).catch(function() {
        showToast('error', 'Không thể sao chép mã khuyến mãi');
    });
}

// Close popup when clicking outside
$(document).on('click', '#promotionPopup', function(e) {
    if (e.target === this) {
        closePromotionPopup();
    }
});

// Close popup with Escape key
$(document).on('keydown', function(e) {
    if (e.key === 'Escape' && $('#promotionPopup').hasClass('show')) {
        closePromotionPopup();
    }
});
</script>
}